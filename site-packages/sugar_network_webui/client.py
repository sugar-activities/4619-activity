# Copyright (C) 2012 Aleksey Lim
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program.  If not, see <http://www.gnu.org/licenses/>.

import socket
import logging

import active_document as ad
from sugar_network.toolkit import sugar, router
from sugar_network import api_url


commands_processor = None
_logger = logging.getLogger('sugar_network')


class ServerError(RuntimeError):
    pass


class Client(object):

    @classmethod
    def call(cls, method, cmd=None, content=None,
            content_type='application/json', **kwargs):
        request = router.Request(**kwargs)
        request.access_level = ad.ACCESS_LOCAL
        request.principal = sugar.uid()
        request['method'] = method
        if cmd:
            request['cmd'] = cmd
        request.content = content
        if method != 'GET':
            request.content_type = content_type
        return commands_processor.call(request)

    @classmethod
    def publish(cls, event, **kwargs):
        kwargs['event'] = event
        commands_processor.publish(kwargs)

    @classmethod
    def connect(cls, callback, **condition):
        commands_processor.connect(callback, condition)

    @classmethod
    def disconnect(cls, callback):
        commands_processor.disconnect(callback)

    @classmethod
    def mounts(cls):
        return cls.call('GET', 'mounts')

    def __init__(self, mountpoint):
        self._mountpoint = mountpoint
        self._resources = {}

    @property
    def connected(self):
        _logger.warning('Client.connected is depecated, '
                'use Client.mounted instead')
        return self.call('GET', 'mounted', mountpoint=self._mountpoint)

    @property
    def mounted(self):
        return self.call('GET', 'mounted', mountpoint=self._mountpoint)

    def launch(self, context, command='activity', object_id=None, uri=None,
            args=None):
        """Launch context implementation.

        Function will call fork at the beginning. In forked process,
        it will try to choose proper implementation to execute and launch it.

        Execution log will be stored in `~/.sugar/PROFILE/logs` directory.

        :param context:
            context GUID to look for implementations
        :param command:
            command that selected implementation should support
        :param object_id:
            optional id to restore Journal object
        :param uri:
            optional uri to open; if implementation supports it
        :param args:
            optional list of arguments to pass to launching implementation

        """
        return self.call('GET', cmd='launch', mountpoint=self._mountpoint,
                document='context', guid=context, object_id=object_id, uri=uri,
                args=args)

    def __getattr__(self, name):
        """Class-like object to access to a resource or call a method.

        :param name:
            resource name started with capital char
        :returns:
            a class-like resource object

        """
        resource = self._resources.get(name)
        if resource is None:
            resource = _Resource(self._mountpoint, name.lower())
            self._resources[name] = resource
        return resource

    def __enter__(self):
        return self


class _Resource(object):

    def __init__(self, mountpoint, name):
        self.mountpoint = mountpoint
        self.document = name

    def url(self, guid, prop):
        return '%s/%s/%s/%s?mountpoint=%s' % (api_url.value, self.document, guid, prop, self.mountpoint)

    def cursor(self, query=None, order_by=None, reply=None, page_size=18,
            **filters):
        """Query resource objects.

        :param query:
            full text search query string in Xapian format
        :param order_by:
            name of property to sort by; might be prefixed by either `+` or `-`
            to change order's direction
        :param reply:
            list of property names to return for found objects;
            by default, only GUIDs will be returned; for missed properties,
            will be sent additional requests to a server on getting access
            to particular object.
        :param page_size:
            number of items in one cached page, there are might be several
            (at least two) pages
        :param filters:
            a dictionary of properties to filter resulting list

        """
        from cursor import Cursor
        return Cursor(self.mountpoint, self.document, query, order_by, reply,
                page_size, **filters)

    def delete(self, guid):
        """Delete resource object.

        :param guid:
            resource object's GUID

        """
        return Client.call('DELETE',
                mountpoint=self.mountpoint, document=self.document, guid=guid)

    def __call__(self, guid=None, reply=None, **kwargs):
        from .objects import Object
        return Object(self.mountpoint, self.document, reply or [], guid,
                **kwargs)
