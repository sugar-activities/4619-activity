<!DOCTYPE HTML>
<head>
    <meta charset="UTF-8" />
    <title>{{_('Welcome to Sugar Network')}}</title>
    <link rel="shortcut icon" href="{{ url_for('static', filename='icons/favicon.ico') }}">
    <link rel="stylesheet" href="/static/css/browser.css" type="text/css" />
    <link rel="stylesheet" href="/static/css/sugar-theme/jquery-ui-1.8.16.sugar.css" />
    <script src="/static/js/jquery.tools.min.js"></script>
    <script src="/static/js/jquery.history.js"></script>
    <script src="/static/js/jquery-ui-1.8.16.sugar.min.js" type="text/javascript"></script>
    <script src="/static/js/jquery.livequery.min.js" type="text/javascript" charset="utf-8"></script>
    <style>
        .sugar-network-online {
            background-color: {{fill}};
            border: 4px solid {{stroke}};
            border-radius: 15px;
            -moz-border-radius: 15px;
            -webkit-border-radius: 15px;
            padding: 2px;
            }
        .ui-autocomplete-loading {
            background: white url('/static/images/throbber5.gif') right center no-repeat;
            }
        .grid-icon:hover {
            color: white;
            padding: 28px;
            background-color: {{fill}};
            border: 4px solid {{stroke}};
            border-radius: 15px;
            -moz-border-radius: 15px;
            -webkit-border-radius: 15px;
            z-index: 50;
            }
        @media (max-width:801px) {
            body {}
            .grid-icon:hover {
                padding: 20px;
            }
            }
    </style>
</head>
<body>
    {% include 'toolbar.html' %}
    <div id="content">
    {% block view %}{% endblock view %}
    </div>
    <div id='bottom-palette'>
        {%- block bottom_palette %}
        <div id='nav-buttons'>
            <a class="prev browse up"></a>
            <a class="next browse down"></a>
        </div>
        {%- endblock bottom_palette %}
        <span id="info">{{info}}</span>
    </div>
    <!--div id="edit-form" class="dialog">
            <div class="window-buttons top-out">
                <img id="accept-button" class="button window-button" src="/static/icons/dialog-ok.png" />
                <img id="cancel-button" class="button window-button" src="/static/icons/dialog-cancel.png" />
            </div>
        <form method="POST" action="/submit_edit">
            <input name="resource-type" type="hidden" value="" />
            <input name="guid" type="hidden" value="" />
            <input id="edit-title" name="title" class="resource-input" type="text" value="" />
            <textarea id="edit-description" class="resource-input" name="description"></textarea>
        </form>
    </div-->
    <div class="dialog" id="mejorar-sistema-form">
        <div id="resource-card-title">
            <span id="dialog-title">{{_('New resource')}} : {{session.get('last_context_title') or _('Sugar Network')}}</span>
            <div class="window-buttons">
                <img id="cancel-button" class="button window-button" src="/static/icons/dialog-cancel.png" />
                {#%- if (session['connected'] or False) -%#}
                <img id="accept-button" class="button window-button" src="/static/icons/dialog-ok.png" />
                {#%- endif -%#}
            </div>
        </div>
        {#%- if (session['connected'] or False) -%#}
        <form id="resource-form1" method="POST" action="/submit_resource">
        <div class="resource-form-field">
            <span id="title_label">{{_('Title')}}</span><br/>
            <input name="guid" type="hidden" value="{{session['last_context']}}" />
            <input onkeypress="return event.keyCode != 13;" name="title" id="title" class="resource-input" type="text"/>
            <input id="resource_type" name="resource_type" type="hidden" value="" />
            <input id="href" name="href" type="hidden" value="" />
            <input id="edit_guid" name="edit_guid" type="hidden" value="" />
        </div>
        <div class="resource-form-field" id="summary_section">
            <span id="summary_label">{{_('Summary')}}</span><br/>
            <input onkeypress="return event.keyCode != 13;" id="summary" name="summary" class="resource-input" type="text"/>
        </div>
        <div class="resource-form-field">
            <span id="details_label">{{_('Details')}}</span><br/>
            <textarea id="edit-content" name="content" class="resource-inputarea" ></textarea>
        </div>
        </form>
        <div id="submit-buttons">
            <img class="question-button button has_tooltip" src="/static/icons/emblem-question.png" title="{{_('submit question')}}" />
            <br />
            <img class="idea-button button has_tooltip" src="/static/icons/emblem-charging.png" title="{{_('submit idea')}}" />
            <br />
            <img class="problem-button button has_tooltip" src="/static/icons/emblem-notification.png" title="{{_('submit problem')}}" />
        </div>
        {#%- else -%}
        <div class="resource-form-field">
            <br/>
            <br/>
            <b>{{_('Alpha Version')}}</b>
            <br/>
            {{_('For the time being you need to be connected to the Internet in order to contribute!')}}
        </div>
        {%- endif -%#}
    </div>
    <script type="text/javascript">
    {%- block script %}
        var oldh;
        var oldw;

        (function(window,undefined){
            // Prepare History.js
            var History = window.History; // Note: We are using a capital H instead of a lower h
            if ( !History.enabled ) {
                 // History.js is disabled for this browser.
                 // This is because we can optionally choose to support HTML4 browsers or not.
                return false;
            }
        })(window);

        function edit_context(guid, title, summary, description) {
            dialog = $('#mejorar-sistema-form');
            oldh = dialog.css('height');
            oldw = dialog.css('width');
            dialog.css('height', '450px');
            dialog.css('width', '700px');
            $('#summary_section').css('height', '73px');
            $('#summary_section').css('padding', '7px 20px');
            $('input#summary').val(summary);
            $('input#title').val(title);
            $('textarea#edit-content').val(description);
            $('#dialog-title').empty().append('{{_("Edit project")}}');
            $('#title_label').empty().append('{{_("Name")}}');
            $('#details_label').empty().append('{{_("Article")}}');
            $('textarea.resource-inputarea').css('height', '170px');
            dialog.expose({
                closeOnClick: false,
                onBeforeClose: function(event) {
                    dialog.fadeOut(
                        function () {
                            dialog.css('height', oldh);
                            dialog.css('width', oldw);
                            $('#title_label').empty().append('{{_("Title")}}');
                            $('#details_label').empty().append('{{_("Details")}}');
                            $('#summary_section').css('height', '0px');
                            $('#summary_section').css('padding', '0px 0px');
                            $('textarea.resource-inputarea').css('height', '100px');
                            $('input#title').val('');
                            $('input#summary').val('');
                            $('textarea#edit-content').val('');
                        }
                    );
                    }
                });
            dialog.fadeIn();
            $('input#title').val(title);
            $('input#resource_type').val(resource_type);
            $('input#edit_guid').val(guid);
            $('input#href').val(location.href);
            $('input#title').focus();

            $('#submit-buttons').hide();
            $('#accept-button').show();
            if (title==false) {
                $('input.resource-input').parent().hide();
                $('#details_label').hide();
                $('input.resource-input').val('');
                }
            else {
                $('#details_label').show();
                $('input.resource-input').parent().show();
                }
            $('#accept-button').click( function () {
                $("#resource-form1").attr('action', '/update_context');
                $("#resource-form1").submit();
                $('#mejorar-sistema-form').fadeOut();
                });

            $('#cancel-button').click( function () {
                $('#mejorar-sistema-form').fadeOut();
                $.mask.close();
                });
            }

        function new_context(resource_type, guid, content, title) {
            dialog = $('#mejorar-sistema-form');
            oldh = dialog.css('height');
            oldw = dialog.css('width');
            dialog.css('height', '450px');
            dialog.css('width', '700px');
            $('#summary_section').css('height', '73px');
            $('#summary_section').css('padding', '7px 20px');
            $('#dialog-title').empty().append('{{_("Create new project")}}');
            $('#title_label').empty().append('{{_("Name")}}');
            $('#details_label').empty().append('{{_("Article")}}');
            $('textarea.resource-inputarea').css('height', '170px');
            dialog.expose({
                closeOnClick: false,
                onBeforeClose: function(event) {
                    dialog.fadeOut(
                        function () {
                            dialog.css('height', oldh);
                            dialog.css('width', oldw);
                            $('#title_label').empty().append('{{_("Title")}}');
                            $('#details_label').empty().append('{{_("Details")}}');
                            $('#summary_section').css('height', '0px');
                            $('#summary_section').css('padding', '0px 0px');
                            $('textarea.resource-inputarea').css('height', '100px');
                            $('input#title').val('');
                            $('input#summary').val('');
                            $('textarea#edit-content').val('');
                        }
                    );
                    }
                });
            dialog.fadeIn();
            $('input#title').val(title);
            $('input#resource_type').val(resource_type);
            $('input#edit_guid').val(guid);
            $('input#href').val(location.href);
            $('input#title').focus();
            $('textarea.edit-content').val(content);

            $('#submit-buttons').hide();
            $('#accept-button').show();
            if (title==false) {
                $('input.resource-input').parent().hide();
                $('#details_label').hide();
                $('input#title').val('');
                }
            else {
                $('#details_label').show();
                $('input.resource-input').parent().show();
                }
            $('#accept-button').click( function () {
                $("#resource-form1").attr('action', '/submit_context');
                $("#resource-form1").submit();
                $('#mejorar-sistema-form').fadeOut();
                });

            $('#cancel-button').click( function () {
                $('#mejorar-sistema-form').fadeOut();
                $.mask.close();
                });
            }

        function edit_resource(resource_type, guid, content, title) {
            dialog = $('#mejorar-sistema-form');
            $('#dialog-title').empty().append('{{_("Edit resource")}}');
            dialog.expose({
                closeOnClick: false,
                onBeforeClose: function(event) {
                    dialog.fadeOut();
                    }
                });
            dialog.fadeIn();
            $('input#title').val(title);
            $('input#resource_type').val(resource_type);
            $('input#edit_guid').val(guid);
            $('input#href').val(location.href);
            $('input#title').focus();
            $('textarea.resource-inputarea').val(content);

            $('#submit-buttons').hide();
            $('#accept-button').show();
            if (title==false) {
                $('input.resource-input').parent().hide();
                $('#details_label').hide();
                $('input#title').val('');
                }
            else {
                $('#details_label').show();
                $('input.resource-input').parent().show();
                }
            $('#accept-button').click( function () {
                $("#resource-form1").attr('action', '/submit_edit');
                $("#resource-form1").submit();
                $('#mejorar-sistema-form').fadeOut();
                });

            $('#cancel-button').click( function () {
                $('#mejorar-sistema-form').fadeOut();
                $.mask.close();
                });
            }

        var _selected = false;
        var _query = false;
        /* var source = new EventSource('/_events/comment');
        source.onmessage = function(e) {
            alert('DEBUG: got event');
            var last_event = e;
            alert(e.data);
            };  */
        function init_styles(inactive_color) {
            if (inactive_color == null){
               inactive_color = '#c9c9c9';
                }
            /* $('.star-emblem').hover( function() {
                $(this).css('background-color','{{fill}}');
                $(this).css('border','1px solid {{stroke}}');
            }, function() {
                $(this).css('background-color', '#fff');
                $(this).css('border','1px solid #fff');
                });
            $('.moon-emblem').hover( function() {
                $(this).css('background-color','{{fill}}');
                $(this).css('border','1px solid {{stroke}}');
            }, function() {
                $(this).css('background-color', '#fff');
                $(this).css('border','1px solid #fff');
                }); */
            $('.box-button').css('visibility', 'hidden');
            $('.grid-item').hover( function() {
                $(".box-button", this).css('visibility', 'visible');
                }, function() {
                $(".box-button", this).css('visibility', 'hidden');
                });
            $('.question-icon').css('background-color', "#D7EBF2");
            $('.question-icon').hover( function() {
                    $(this).css('background-color', '#3b4ad7');
                }, function() {
                    $(this).css('background-color', "#D7EBF2");
                });
            $('.idea-icon').css('background-color', "#D7EBF2");
            $('.idea-icon').hover( function() {
                    $(this).css('background-color', '#fcef30');
                }, function() {
                    $(this).css('background-color', "#D7EBF2");
                });
            $('.problem-icon').css('background-color', "#D7EBF2");
            $('.problem-icon').hover( function() {
                    $(this).css('background-color', '#e53490');
                }, function() {
                    $(this).css('background-color', "#D7EBF2");
                });
            $('.review-icon').css('background-color', "#D7EBF2");
            $('.review-icon').hover( function() {
                    $(this).css('background-color', '#98C40C');
                }, function() {
                    $(this).css('background-color', "#D7EBF2");
                });
            $('.gallery-icon').css('background-color', "#D7EBF2");
            $('.gallery-icon').hover( function() {
                    $(this).css('background-color', '#98C40C');
                }, function() {
                    $(this).css('background-color', "#D7EBF2");
                });
            $('.wiki-icon').css('background-color', "#D7EBF2");
            $('.wiki-icon').hover( function() {
                    $(this).css('background-color', '#98C40C');
                }, function() {
                    $(this).css('background-color', "#D7EBF2");
                });
            // Make sure selected resource is highlighted
            resource='.{{resource_type}}';
            $(resource+'-icon').css('background-color', "#9ccec9");
            $(resource+'-icon').unbind('mouseenter mouseleave');
            $('.button_selected').css('background-color', "#9CCEC9");
            $('.button_selected').unbind('mouseenter mouseleave');
            //
            $('.star-emblem').click( function() {
                if ( $(this).data('favorite') == true) {
                    $(this).css('background-color', '#fff');
                    $(this).css('border','1px solid #fff');
                    $(this).data('favorite', false);
                    }
                else {
                    $(this).css('background-color','{{fill}}');
                    $(this).css('border','1px solid {{stroke}}');
                    $(this).data('favorite', true);
                    }
                $.get('/_stars/' + $(this).attr("id") + '?favorite=' +
                    $(this).data('favorite'),
                    function (data) {/* alert (data.favorite) */} );
                });
            $('.moon-emblem').click( function() {
                if ( $(this).data('clone') == true) {
                    $(this).css('background-color', '#fff');
                    $(this).css('border','1px solid #fff');
                    $(this).data('clone', false);
                    }
                else {
                    $(this).css('background-color','{{fill}}');
                    $(this).css('border','1px solid {{stroke}}');
                    $(this).data('clone', true);
                    }
                $.get('/_moon/' + $(this).attr("id") + '?clone=' +
                    $(this).data('clone'),
                    function (data) {/* alert (data.favorite) */} );
                });
        };
    /* For deleting elements from tag palette */
    function bind_del () {
        $('.tag').click( function () {
            $(this).fadeOut();
            $.ajax({
                url: '/_tags/'+$(this).html(),
                type: 'DELETE',
                success: function(result) {
                    location.reload();
                    }
                });
            });
        }
   $(document).ready( function() {
        bind_del();
        $( "#sn-button" ).tooltip({position:"bottom right", offset:[-3,-60], predelay:500});
        $( "#browser-button" ).tooltip({position:"bottom right", offset:[-3,-60], predelay:500});
        $( ".has_tooltip" ).livequery( function () {

            $( this ).tooltip({position:"bottom right", tipClass:"generic_tooltip"
/*                onShow: function(event, position) {
                    var tip = this.getTip();
                    var new_pos = $(window).width() - (parseInt( tip.css( 'width' ), 10) + 110);
                    tip.css( 'position', "fixed" );
                    tip.css( 'top', "4px" );
                    tip.css( 'left', new_pos + "px" );

                }
                */
            })
            });

        $( ".has_tooltip_left" ).livequery( function () {

            $( this ).tooltip({position:"bottom left", tipClass:"generic_tooltip"})

            });

        /*$( "#list-button" ).tooltip({position:"bottom right", offset:[-3,-60], predelay:500});*/
        $( "#query" ).autocomplete({
            source: "/query",
            dataType: "json",
            minLength: 2,
            change: function( ev ) {
                var term = $('#query').val();
                _query = term;
                if(ev.keyCode == 13) {
                    location='/context/search/'+term;
                    }
                },
            select: function( ev, ui ) {
                var e = ev || event;
                _selected = true;
                var term = $('#query').val();
                location='/context/reviews/'+ui.item.value;
                return false;
                },
            focus: function (ev, ui) {
                return false;
                },
            search: function (ev, ui) {
                var term = $('#query').val();
                if (term.indexOf(' ')!=-1) {
                    $('#query').autocomplete('close');
                    return false;
                    }
                }
            }
        );
        $( "#query" ).keyup(onKeyPressed);
    });

    function onKeyPressed(ev) {
        var e = ev || event;
        var term = $('#query').val();
        if(e.keyCode == 13 && _selected==false) {
            location='/context/search/'+term;
            /* For adding tag filters */
            /** if (term[0]=='#') {
                /* Send the data using post *
                $('#query').val('{{query or ''}}');
                $.post( '/_tags', { tag:term },
                  function( data ) {
                    $( "#tags-section" ).empty().append( data );
                    /* bind_del(); *
                    location.reload();
                  }
                );
                }
            else {
                /* location='/resource/{{resource_type}}s/'+term; *
                location='/context/search/'+term;
                }*/
            return false; //prevents form from being submitted.
        }
    }
    {%- endblock script %}
    </script>
</body>
</html>
